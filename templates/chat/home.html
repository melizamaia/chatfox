<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>ChatFox ‚Äì Teste WebSocket</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 900px;
        margin: 20px auto;
      }
      textarea {
        width: 100%;
      }
      #log {
        height: 180px;
      }
      .row {
        margin-bottom: 1rem;
      }
      label {
        font-weight: 600;
      }
      .ok {
        color: green;
      }
      .err {
        color: red;
      }
      .status {
        padding: 4px 8px;
        border-radius: 6px;
        background: #eee;
        display: inline-block;
        margin-left: 8px;
      }
    </style>
  </head>
  <body>
    <h1>ChatFox ‚Äì Teste de WebSocket autenticado</h1>

    <p>
      ‚úÖ Backend Django est√° ok.<br />
      ‚úÖ JWT est√° ok (voc√™ j√° conseguiu o <code>access</code>).<br />
      üëâ Agora vamos s√≥ conectar no WebSocket usando o token.
    </p>

    <div class="row">
      <label for="token">Token JWT (access):</label><br />
      <textarea id="token" rows="3" placeholder="cole aqui o access token que veio do /api/auth/login/"></textarea>
    </div>

    <div class="row">
      <label for="room">Sala:</label><br />
      <input id="room" value="sala1" />
    </div>

    <div class="row">
      <button id="connect">Conectar WS</button>
      <button id="disconnect">Desconectar</button>
      <span id="status" class="status">desconectado</span>
    </div>

    <div class="row">
      <label for="log">Mensagens:</label><br />
      <textarea id="log" readonly></textarea>
    </div>

    <div class="row">
      <input id="msg" type="text" placeholder="Mensagem..." style="width: 80%" />
      <button id="send">Enviar</button>
    </div>

    <p>
      Dica: abra essa p√°gina em duas abas diferentes, conecte nas duas com o mesmo token e mesma sala,
      e mande mensagem ‚Äî voc√™ vai ver chegando nas duas.
    </p>

    <script>
      let ws = null;

      function appendLog(text) {
        const log = document.getElementById("log");
        log.value += text + "\n";
        log.scrollTop = log.scrollHeight;
      }

      document.getElementById("connect").onclick = function () {
        const token = document.getElementById("token").value.trim();
        const room = document.getElementById("room").value.trim() || "sala1";

        if (!token) {
          alert("Cole o access token primeiro.");
          return;
        }

        // monta a URL do WebSocket
        const wsUrl = `ws://${window.location.host}/ws/chat/${room}/?token=${token}`;
        appendLog("üîó conectando em: " + wsUrl);

        ws = new WebSocket(wsUrl);

        ws.onopen = function () {
          document.getElementById("status").textContent = "‚úÖ conectado";
          document.getElementById("status").style.background = "#d6ffcf";
          appendLog("‚úÖ conectado ao WebSocket");
        };

        ws.onmessage = function (event) {
          appendLog("üì© " + event.data);
        };

        ws.onclose = function (event) {
          document.getElementById("status").textContent = "‚ùå desconectado";
          document.getElementById("status").style.background = "#ffe0e0";
          appendLog("‚ùå conex√£o fechada");
        };

        ws.onerror = function (event) {
          appendLog("‚ö†Ô∏è erro no WebSocket (veja o terminal do Django)");
        };
      };

      document.getElementById("disconnect").onclick = function () {
        if (ws) {
          ws.close();
          ws = null;
        }
      };

      document.getElementById("send").onclick = function () {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          alert("WebSocket n√£o est√° conectado.");
          return;
        }
        const msg = document.getElementById("msg").value;
        ws.send(JSON.stringify({ message: msg }));
        document.getElementById("msg").value = "";
      };
    </script>
  </body>
</html>
